(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{7207:function(e,t,i){Promise.resolve().then(i.bind(i,6047))},6047:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return K}});var l,s=i(7437),a=i(2265);function r(e){let t=0,i=0;for(;0===t;)t=e();for(;0===i;)i=e();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*i)}function n(e){var t,i,l;let{S0:s,regime:a,days:n,seed:d=11,randomize:o=!0,driftNoise:u=.02,volOfVol:c=.1,meanRevert:h=.2,jumps:p}=e,x=(l=0|d,function(){let e=l+=1831565813;return e=Math.imul(e^e>>>15,1|e),(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}),m=[s],g=[],y=[],v=a.baseMu,f=a.baseSigma,j=(null==p?void 0:p.enabled)&&p.lambda||0,b=null!==(t=null==p?void 0:p.muJ)&&void 0!==t?t:-.2,S=null!==(i=null==p?void 0:p.sigmaJ)&&void 0!==i?i:.25,L=Math.exp(b+.5*S*S)-1;for(let e=1;e<=n;e++){if(o){let e=r(x)*u;v=a.baseMu+.9*(v-a.baseMu)+e;let t=r(x)*c*f;f=Math.max(.05,f+h*(a.baseSigma-f)+t)}else v=a.baseMu,f=a.baseSigma;let t=1/252,i=1/252*(v-.5*f*f-j*L)+f*Math.sqrt(1/252)*r(x);if(j>0){let e=j*t;x()<e&&(i+=b+S*r(x))}let l=m[e-1]*Math.exp(i);m.push(l),g.push(v),y.push(f)}let M=new Date;return{dates:m.map((e,t)=>{let i=new Date(M);return i.setDate(M.getDate()+t),i.toISOString().slice(0,10)}),prices:m,muSeries:g,sigmaSeries:y}}let d={BULL:{key:"BULL",label:"Bullish",baseMu:.08,baseSigma:.2},NEUTRAL:{key:"NEUTRAL",label:"Neutral",baseMu:0,baseSigma:.2},BEAR:{key:"BEAR",label:"Bearish",baseMu:-.08,baseSigma:.25},VOLATILE:{key:"VOLATILE",label:"Volatile",baseMu:0,baseSigma:.4},CUSTOM:{key:"CUSTOM",label:"Custom",baseMu:.05,baseSigma:.25}},o=e=>{let t=Math.abs(e),i=1/(1+.3275911*t);return(e<0?-1:1)*(1-((((1.061405429*i+-1.453152027)*i+1.421413741)*i+-.284496736)*i+.254829592)*i*Math.exp(-t*t))},u=e=>.5*(1+o(e/Math.SQRT2)),c=e=>Math.exp(-.5*e*e)/Math.sqrt(2*Math.PI);function h(e,t,i,l,s,a,r){if(s<=0||a<=0)return"CALL"===r?Math.max(0,e-t):Math.max(0,t-e);let n=Math.sqrt(a),d=(Math.log(e/t)+(i-l+.5*s*s)*a)/(s*n),o=d-s*n,c=Math.exp(-l*a),h=Math.exp(-i*a);return"CALL"===r?e*c*u(d)-t*h*u(o):t*h*u(-o)-e*c*u(-d)}function p(e,t,i,l,s,a,r){let n=Math.sqrt(Math.max(1e-8,a)),d=(Math.log(e/t)+(i-l+.5*s*s)*a)/(s*n),o=d-s*n,h=Math.exp(-l*a),p=Math.exp(-i*a),x="CALL"===r?h*u(d):-h*u(-d),m=h*c(d)/(e*s*n),g=e*h*c(d)*n,y=-(e*h*c(d)*s)/(2*n)-i*t*p*u(o)+l*e*h*u(d),v=-(e*h*c(d)*s)/(2*n)+i*t*p*u(-o)-l*e*h*u(-d);return{delta:x,gamma:m,vega:g,theta:"CALL"===r?y:v}}function x(e){return Math.round((e+Number.EPSILON)*100)/100}function m(){return{legs:[],realized:0}}let g=e=>"LONG"===e?1:-1;function y(e,t,i,l){return x(h(i,e.strike,t.r,t.q,t.sigma,Math.max(0,l),e.right))}function v(e,t,i,l){let s=x(l.prices[i]),a=Math.max(0,(e.expiryIndex?e.expiryIndex-i:0)/365);return e.legs.reduce((e,i)=>{let l=p(s,i.strike,t.r,t.q,t.sigma,Math.max(1e-8,a),i.right);return e.delta+=g(i.side)*i.quantity*l.delta,e.gamma+=g(i.side)*i.quantity*l.gamma,e.vega+=g(i.side)*i.quantity*l.vega,e.theta+=g(i.side)*i.quantity*l.theta,e},{delta:0,gamma:0,vega:0,theta:0})}function f(e,t,i,l){return l.reduce((l,s)=>l+("LONG"===s.side?1:-1)*s.quantity*x(h(t,s.strike,e.r,e.q,e.sigma,Math.max(0,i),s.right)),0)}var j=i(7346),b=i(5211);function S(e){let{labels:t,datasets:i,height:l=120}=e,a=i.map(e=>({label:e.label,data:e.data,borderColor:e.color,pointRadius:0}));return(0,s.jsx)(j.x1,{data:{labels:t,datasets:a},options:{animation:!1,plugins:{legend:{display:!0}},scales:{x:{ticks:{maxTicksLimit:10}}}},height:l})}b.kL.register(b.jn,b.f$,b.od,b.uw,b.u,b.De),b.kL.register(b.jn,b.f$,b.od,b.uw,b.u,b.De);let L=["#60a5fa","#22c55e","#eab308","#f97316","#a78bfa","#14b8a6","#f43f5e"];function M(e){var t,i;let{series:l}=e,a=l.map((e,t)=>{var i;return{label:e.label,data:e.values,borderColor:null!==(i=e.color)&&void 0!==i?i:L[t%L.length],backgroundColor:"transparent",pointRadius:0,borderWidth:1.5}}),r=null!==(i=null===(t=l[0])||void 0===t?void 0:t.prices.map(e=>e.toFixed(2)))&&void 0!==i?i:[];return(0,s.jsx)(j.x1,{data:{labels:r,datasets:a},options:{animation:!1,plugins:{legend:{display:!0}},scales:{x:{ticks:{maxTicksLimit:10}}}},height:140})}function N(e){let{prices:t,payoff:i}=e,l={labels:t.map(e=>e.toFixed(2)),datasets:[{label:"P/L @ Expiry",data:i,borderColor:"#60a5fa",backgroundColor:"rgba(96,165,250,0.15)",fill:!0,pointRadius:0}]};return(0,s.jsx)(j.x1,{data:l,options:{animation:!1,plugins:{legend:{display:!1}},scales:{x:{ticks:{maxTicksLimit:10}}}},height:110})}function k(e){var t,i;let{env:l,currentIndex:r,position:n,onClose:d,onSubmit:o,hist:u,preset:c}=e,p=null!==(t=null==c?void 0:c.expiryDays)&&void 0!==t?t:n.expiryIndex?Math.max(1,n.expiryIndex-r):30,m=(null!==(i=null==c?void 0:c.legs)&&void 0!==i?i:[{side:"LONG",right:"CALL",quantity:1,strike:Math.round(u.prices[r])}]).map(e=>({id:crypto.randomUUID(),...e})),[v,j]=(0,a.useState)(p),[b,S]=(0,a.useState)(m),[L,M]=(0,a.useState)({});(0,a.useEffect)(()=>{c&&(j(c.expiryDays),S(c.legs.map(e=>({id:crypto.randomUUID(),...e}))))},[null==c?void 0:c.expiryDays,JSON.stringify((null==c?void 0:c.legs)||[])]);let k=u.prices[r],O=n.expiryIndex?Math.max(0,(n.expiryIndex-r)/365):Math.max(1,Math.round(v))/365,C=(0,a.useMemo)(()=>f(l,k,O,b),[l,k,O,b]),q=(0,a.useMemo)(()=>(function(e,t,i,l){let s=f(e,t,i,l),a=Math.max(.1,.7*t),r=1.3*t,n=[],d=[];for(let e=0;e<=200;e++){let t=a+e/200*(r-a),i=l.reduce((e,i)=>{let l="CALL"===i.right?Math.max(0,t-i.strike):Math.max(0,i.strike-t);return e+("LONG"===i.side?1:-1)*i.quantity*l},0);n.push(t),d.push(i+s)}return[n,d]})(l,k,O,b),[l,k,O,b]),I=(e,t)=>S(b.map(i=>i.id===e?{...i,...t}:i)),P=e=>S(b.filter(t=>t.id!==e));return(0,s.jsx)("div",{className:"modal",children:(0,s.jsxs)("div",{className:"modal-body",style:{maxWidth:900},children:[(0,s.jsxs)("h3",{children:["Take action (day ",r,")"]}),(0,s.jsx)("div",{className:"row wrap",children:(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"Expiry (days)"}),(0,s.jsx)("input",{type:"number",value:v,min:1,step:1,onChange:e=>j(parseInt(e.target.value||"1"))})]})}),n.legs.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("h4",{children:"Existing legs — close partially"}),(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Side"}),(0,s.jsx)("th",{children:"Right"}),(0,s.jsx)("th",{children:"Qty"}),(0,s.jsx)("th",{children:"Strike"}),(0,s.jsx)("th",{children:"Now px"}),(0,s.jsx)("th",{children:"Close qty"})]})}),(0,s.jsx)("tbody",{children:n.legs.map(e=>{var t;let i=Math.max(0,(n.expiryIndex-r)/365),a=x(h(k,e.strike,l.r,l.q,l.sigma,i,e.right)),d=Math.max(0,Math.min(e.quantity,null!==(t=L[e.id])&&void 0!==t?t:0));return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.side}),(0,s.jsx)("td",{children:e.right}),(0,s.jsx)("td",{children:e.quantity}),(0,s.jsx)("td",{children:e.strike}),(0,s.jsx)("td",{children:a.toFixed(2)}),(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"number",value:d,min:0,max:e.quantity,step:1,onChange:t=>M({...L,[e.id]:parseInt(t.target.value||"0",10)})})})]},e.id)})})]})]}),(0,s.jsxs)("h4",{children:["New legs (to add ",n.expiryIndex?"at same expiry":"as new position",")"]}),b.map(e=>(0,s.jsxs)("div",{className:"row leg",children:[(0,s.jsxs)("select",{value:e.side,onChange:t=>I(e.id,{side:t.target.value}),children:[(0,s.jsx)("option",{value:"LONG",children:"LONG"}),(0,s.jsx)("option",{value:"SHORT",children:"SHORT"})]}),(0,s.jsxs)("select",{value:e.right,onChange:t=>I(e.id,{right:t.target.value}),children:[(0,s.jsx)("option",{value:"CALL",children:"CALL"}),(0,s.jsx)("option",{value:"PUT",children:"PUT"})]}),(0,s.jsxs)("label",{className:"field small",children:[(0,s.jsx)("span",{children:"Qty"}),(0,s.jsx)("input",{type:"number",value:e.quantity,min:1,step:1,onChange:t=>I(e.id,{quantity:parseInt(t.target.value||"1",10)})})]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"Strike"}),(0,s.jsx)("input",{type:"number",value:e.strike,step:.5,onChange:t=>I(e.id,{strike:parseFloat(t.target.value)})})]}),(0,s.jsxs)("span",{className:"muted",children:["Price: ",h(k,e.strike,l.r,l.q,l.sigma,O,e.right).toFixed(2)]}),(0,s.jsx)("button",{className:"danger",onClick:()=>P(e.id),children:"Remove"})]},e.id)),(0,s.jsx)("button",{onClick:()=>S([...b,{id:crypto.randomUUID(),side:"LONG",right:"CALL",quantity:1,strike:Math.round(k)}]),children:"+ Add leg"}),(0,s.jsxs)("div",{className:"panel",style:{marginTop:12},children:[(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsx)("b",{children:"Order premium (credit + / debit −):"})," ",C.toFixed(2)]}),(0,s.jsx)("div",{children:(0,s.jsx)(N,{prices:q[0],payoff:q[1]})})]}),(0,s.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,s.jsx)("button",{onClick:d,children:"Cancel (Esc)"}),(0,s.jsx)("button",{className:"danger",onClick:()=>o((e,t,i,l)=>(function(e,t,i,l){if(0===e.legs.length)return e;let s=x(l.prices[i]),a=Math.max(0,(e.expiryIndex-i)/365),r=e.legs.reduce((e,i)=>e+g(i.side)*i.quantity*y(i,t,s,a),0),n=e.legs.reduce((e,t)=>e+("LONG"===t.side?1:-1)*t.quantity*t.entryPrice,0);return{legs:[],expiryIndex:void 0,realized:e.realized+(r-n)}})(e,t,i,l)),children:"Close all"}),(0,s.jsx)("button",{onClick:()=>o((e,t,i,l)=>{let s=function(e,t,i,l,s){if(0===e.legs.length)return e;let a=x(l.prices[i]),r=Math.max(0,(e.expiryIndex-i)/365),n=e.realized,d=[];for(let i of e.legs){var o,u;let e=Math.max(0,Math.min(i.quantity,null!==(o=s[i.id])&&void 0!==o?o:0));if(e>0){let l=y(i,t,a,r);n+=("LONG"===i.side?1:-1)*e*(l-i.entryPrice)}let l=i.quantity-(null!==(u=s[i.id])&&void 0!==u?u:0);l>0&&d.push({...i,quantity:l})}let c={...e,legs:d,realized:n};return 0===c.legs.length&&(c.expiryIndex=void 0),c}(e,t,i,l,L);return b.length>0&&(s=s.expiryIndex?function(e,t,i,l,s){if(void 0===e.expiryIndex)throw Error("openAdditional: no existing expiry to add to");let a=x(l.prices[i]),r=Math.max(0,(e.expiryIndex-i)/365),n=s.map(e=>({id:crypto.randomUUID(),side:e.side,right:e.right,quantity:e.quantity,strike:e.strike,entryPrice:y(e,t,a,r)}));return{...e,legs:[...e.legs,...n]}}(s,t,i,l,b):function(e,t,i,l,s){let a=i+Math.max(1,Math.round(s.expiryDays)),r=x(l.prices[i]),n=(a-i)/365;return{legs:s.legs.map(e=>({id:crypto.randomUUID(),side:e.side,right:e.right,quantity:e.quantity,strike:e.strike,entryPrice:y(e,t,r,n),entryIndex:i})),expiryIndex:a,realized:e.realized}}(s,t,i,l,{expiryDays:v,legs:b})),s}),children:"Apply changes (same expiry)"})]})]})})}function O(e){let{regime:t,setRegime:i,custom:l,setCustom:a,randomize:r,setRandomize:n,jumps:d,setJumps:o}=e;return(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Market regime"}),(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsxs)("select",{value:t,onChange:e=>i(e.target.value),children:[(0,s.jsx)("option",{value:"BULL",children:"Bullish"}),(0,s.jsx)("option",{value:"NEUTRAL",children:"Neutral"}),(0,s.jsx)("option",{value:"BEAR",children:"Bearish"}),(0,s.jsx)("option",{value:"VOLATILE",children:"Volatile"}),(0,s.jsx)("option",{value:"CUSTOM",children:"Custom"})]}),"CUSTOM"===t&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"μ (annual drift)"}),(0,s.jsx)("input",{type:"number",step:.01,value:l.mu,onChange:e=>a({...l,mu:parseFloat(e.target.value)})})]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"σ (annual vol)"}),(0,s.jsx)("input",{type:"number",step:.01,value:l.sigma,onChange:e=>a({...l,sigma:parseFloat(e.target.value)})})]})]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"Seed"}),(0,s.jsx)("input",{type:"number",value:l.seed,onChange:e=>a({...l,seed:parseInt(e.target.value||"1")})})]}),(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"checkbox",checked:r,onChange:e=>n(e.target.checked)})," Randomize μ & σ"]})]}),(0,s.jsx)("h4",{children:"Jump risk (Merton)"}),(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"checkbox",checked:d.enabled,onChange:e=>o({...d,enabled:e.target.checked})})," Enable jumps"]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"λ (per year)"}),(0,s.jsx)("input",{type:"number",step:.1,min:0,value:d.lambda,onChange:e=>o({...d,lambda:parseFloat(e.target.value)})})]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsxs)("span",{children:["μ",(0,s.jsx)("sub",{children:"J"})," (log)"]}),(0,s.jsx)("input",{type:"number",step:.05,value:d.muJ,onChange:e=>o({...d,muJ:parseFloat(e.target.value)})})]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsxs)("span",{children:["σ",(0,s.jsx)("sub",{children:"J"})]}),(0,s.jsx)("input",{type:"number",step:.05,min:0,value:d.sigmaJ,onChange:e=>o({...d,sigmaJ:parseFloat(e.target.value)})})]})]})]})}b.kL.register(b.jn,b.f$,b.od,b.uw,b.u,b.De);let C=[{key:"long_call_atm",label:"Long Call (ATM)",build:e=>[{side:"LONG",right:"CALL",quantity:1,strike:Math.round(e)}]},{key:"bull_call_spread",label:"Bull Call Spread",build:e=>[{side:"LONG",right:"CALL",quantity:1,strike:Math.round(.98*e)},{side:"SHORT",right:"CALL",quantity:1,strike:Math.round(1.05*e)}]},{key:"long_put_atm",label:"Long Put (ATM)",build:e=>[{side:"LONG",right:"PUT",quantity:1,strike:Math.round(e)}]},{key:"bear_put_spread",label:"Bear Put Spread",build:e=>[{side:"LONG",right:"PUT",quantity:1,strike:Math.round(1.02*e)},{side:"SHORT",right:"PUT",quantity:1,strike:Math.round(.95*e)}]},{key:"long_straddle",label:"Long Straddle (ATM)",build:e=>[{side:"LONG",right:"CALL",quantity:1,strike:Math.round(e)},{side:"LONG",right:"PUT",quantity:1,strike:Math.round(e)}]},{key:"short_strangle",label:"Short Strangle (\xb110%)",build:e=>[{side:"SHORT",right:"CALL",quantity:1,strike:Math.round(1.1*e)},{side:"SHORT",right:"PUT",quantity:1,strike:Math.round(.9*e)}]},{key:"iron_condor",label:"Iron Condor (\xb110/20%)",build:e=>[{side:"SHORT",right:"CALL",quantity:1,strike:Math.round(1.1*e)},{side:"LONG",right:"CALL",quantity:1,strike:Math.round(1.2*e)},{side:"SHORT",right:"PUT",quantity:1,strike:Math.round(.9*e)},{side:"LONG",right:"PUT",quantity:1,strike:Math.round(.8*e)}]}];function q(e){let{S:t,T:i,env:l,onPick:r}=e,[n,d]=(0,a.useState)(1234),[o,u]=(0,a.useState)(3e3),c=(0,a.useMemo)(()=>i>0?function(e){var t;let{S0:i,T:l,env:s,seed:a=1234,n:r=3e3}=e,n=(t=0|a,function(){let e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}),d=[];for(let e of C){let t=e.build(i),a=t.reduce((e,t)=>e+("LONG"===t.side?1:-1)*t.quantity*x(h(i,t.strike,s.r,s.q,s.sigma,l,t.right)),0),o=[];for(let e=0;e<r;e++){let e=function(e){let t=0,i=0;for(;0===t;)t=e();for(;0===i;)i=e();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*i)}(n),r=i*Math.exp((s.r-s.q-.5*s.sigma*s.sigma)*l+s.sigma*Math.sqrt(l)*e),d=t.reduce((e,t)=>{let i="CALL"===t.right?Math.max(0,r-t.strike):Math.max(0,t.strike-r);return e+("LONG"===t.side?1:-1)*t.quantity*i},0);o.push(d+a)}o.sort((e,t)=>e-t);let u=o.reduce((e,t)=>e+t,0)/r,c=o[Math.floor(r/2)],p=o.filter(e=>e>0).length/r;d.push({key:e.key,label:e.label,premium:a,ev:u,median:c,pop:p})}return d.sort((e,t)=>t.ev-e.ev),d}({S0:t,T:i,env:l,seed:n,n:o}):[],[t,i,l,n,o]);return(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Learning Mode (beta)"}),(0,s.jsx)("p",{className:"muted",children:"Educational-only. Uses Monte Carlo under risk-neutral drift (r−q), current σ and T."}),(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"Seed"}),(0,s.jsx)("input",{type:"number",value:n,onChange:e=>d(parseInt(e.target.value||"0"))})]}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"Samples"}),(0,s.jsx)("input",{type:"number",value:o,min:500,max:2e4,step:500,onChange:e=>u(parseInt(e.target.value||"1000"))})]})]}),0===c.length?(0,s.jsx)("p",{className:"muted",children:"No T available. Open or set an expiry to evaluate."}):(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Template"}),(0,s.jsx)("th",{children:"Premium"}),(0,s.jsx)("th",{children:"EV"}),(0,s.jsx)("th",{children:"Median"}),(0,s.jsx)("th",{children:"PoP"}),(0,s.jsx)("th",{})]})}),(0,s.jsx)("tbody",{children:c.map(e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.label}),(0,s.jsx)("td",{children:e.premium.toFixed(2)}),(0,s.jsx)("td",{children:(0,s.jsx)("b",{children:e.ev.toFixed(2)})}),(0,s.jsx)("td",{children:e.median.toFixed(2)}),(0,s.jsxs)("td",{children:[(100*e.pop).toFixed(1),"%"]}),(0,s.jsx)("td",{children:(0,s.jsx)("button",{onClick:()=>r(e.key),children:"Use"})})]},e.key))})]})]})}function I(e,t){if(e.length<t)return null;let i=0;for(let l=e.length-t;l<e.length;l++)i+=e[l];return i/t}function P(e){let{S:t,env:i,dates:l,prices:r,jumpsEnabled:n}=e,d=(0,a.useMemo)(()=>{let e=I(r,5),t=I(r,20),l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;if(e.length<t+1)return null;let i=[];for(let l=e.length-t;l<e.length;l++){let t=Math.log(e[l]/e[l-1]);i.push(t)}return Math.sqrt(i.reduce((e,t)=>e+t*t,0)/Math.max(1,i.length-1))*Math.sqrt(252)}(r,20),s=i.sigma,a=[],d="";if(e&&t){let i=e>1.002*t,r=e<.998*t;i&&s<(null!=l?l:s)*.9?(d="Bull Call Spread or Long Call",a.push("Uptrend with relatively low IV vs RV favors debit bullish strategies with convexity.")):r&&s<(null!=l?l:s)*1.1?(d="Bear Put Spread or Long Put",a.push("Downtrend with modest IV: defined-risk bearish plays.")):i||r||!(s>(null!=l?l:s)*1.3)?(d="Long Straddle/Strangle (if IV low) or Wait",a.push("Signal unclear: consider convexity if IV is cheap or wait for clarity.")):(d="Iron Condor or Short Strangle (beware margin)",a.push("Sideways + high IV: short premium/defined risk spreads capture theta."))}else d="Gather more data",a.push("Not enough history yet to infer trend.");return n&&a.push("Jump risk ON → prefer **defined-risk** structures (spreads) over naked shorts."),{rec:d,rationale:a}},[t,i,l,r,n]);return(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Coach (when/why)"}),(0,s.jsxs)("p",{children:[(0,s.jsx)("b",{children:"Suggestion:"})," ",d.rec]}),(0,s.jsx)("ul",{children:d.rationale.map((e,t)=>(0,s.jsx)("li",{className:"muted",children:e},t))})]})}function T(e){return"${prefix}_${Math.random().toString(36).slice(2, 10)}"}function E(e,t){return e.positions[t]||(e.positions[t]={symbol:t,lots:[],totalShares:0,avgCost:0,reservedShares:0}),e.positions[t]}function _(e,t){e.ledger.push(t)}function w(e){let t=e.lots.reduce((e,t)=>e+t.shares,0),i=e.lots.reduce((e,t)=>e+t.shares*t.costBasis,0);e.totalShares=t,e.avgCost=t>0?i/t:0}class A{setPrice(e,t){this.prices[e]=t}getUnrealizedRows(){return function(e,t){let i=[];for(let[s,a]of Object.entries(e.positions)){var l;let e=null!==(l=t[s])&&void 0!==l?l:0,r=(e-a.avgCost)*a.totalShares;i.push({symbol:s,shares:a.totalShares,avgCost:a.avgCost,price:e,unrealized:r})}return i}(this.pf,this.prices)}resetInitialDeposit(e){var t;if(!Number.isFinite(e)||e<0)return;let i=e-(null!==(t=this.pf.cash.initial)&&void 0!==t?t:e);this.pf.cash.initial=e,this.pf.cash.available+=i}constructor(e=1e5,t="USD"){this.prices={},this.currency="USD",this.currency=t,this.pf=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"USD";return{timestamp:Date.now(),cash:{currency:t,available:e,initial:e,reserved:0},positions:{},ledger:[]}}(e,t)}}let D=new A(5e4,"USD");function U(e){return Math.round((e+Number.EPSILON)*100)/100}function G(e,t){var i,l,s,a,r;let n={id:null!==(i=t.id)&&void 0!==i?i:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"led";return"".concat(e,"-").concat(Math.random().toString(36).slice(2,9))}("led"),timestamp:null!==(l=t.timestamp)&&void 0!==l?l:Date.now(),type:t.type,symbol:t.symbol,details:null!==(s=t.details)&&void 0!==s?s:{},cashDelta:U(null!==(a=t.cashDelta)&&void 0!==a?a:0),realizedPnL:U(null!==(r=t.realizedPnL)&&void 0!==r?r:0)};return e.ledger.push(n),n}function z(e){var t;return U((null!==(t=e.ledger)&&void 0!==t?t:[]).reduce((e,t)=>{var i;return e+(null!==(i=t.realizedPnL)&&void 0!==i?i:0)},0))}let R=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}).format(e);function F(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(x(e))}function B(e){var t,i;let{S:l,env:r,pos:n,idx:d,hist:o}=e,[u,c]=(0,a.useState)([]),[p,m]=(0,a.useState)(D.pf.cash.available),[g,y]=(0,a.useState)(D.pf.cash.reserved),[f,j]=(0,a.useState)(z(D.pf)),[b,S]=(0,a.useState)("XYZ"),[L,M]=(0,a.useState)(100),[N,k]=(0,a.useState)(l),[O,C]=(0,a.useState)(0),[q,I]=(0,a.useState)(0),[P,A]=(0,a.useState)(0),U=void 0!==n.expiryIndex?Math.max(0,n.expiryIndex-d):0,G=U/365,B=void 0!==n.expiryIndex?U:void 0,H=n.legs.map(e=>{x(h(l,e.strike,r.r,r.q,r.sigma,G,e.right));let t=x(e.entryPrice),i="LONG"===e.side?1:-1,s=x(h(l,e.strike,r.r,r.q,r.sigma,G,e.right)),a=i*(s-t)*100*e.quantity;return{type:"Option",symbol:"-",side:e.side,right:e.right,qty:e.quantity,strike:e.strike,expiryAbs:n.expiryIndex,dte:B,entryPrice:100*e.entryPrice,lastPrice:100*s,unrealized:a}});n.legs.reduce((e,t)=>{let i=h(l,t.strike,r.r,r.q,r.sigma,G,t.right);return e+("LONG"===t.side?1:-1)*(i-t.entryPrice)*100*t.quantity},0);let Y=()=>{var e,t;let i=null!==(t=null===(e=D.getUnrealizedRows)||void 0===e?void 0:e.call(D))&&void 0!==t?t:[],s=x(l);c(i.map(e=>{let t=x(e.avgCost),i=x((s-t)*e.shares);return{type:"Stock",symbol:e.symbol,qty:e.shares,avgCost:t,lastPrice:s,unrealized:i}}));let a=x(D.pf.cash.available),u=x(function(e,t,i,l){var s;let a=null!==(s=l.prices[i])&&void 0!==s?s:0,r=void 0!==e.expiryIndex?Math.max(0,(e.expiryIndex-i)/365):0,n=0;for(let i of e.legs){let e=x(h(a,i.strike,t.r,t.q,t.sigma,r,i.right));n+=("LONG"===i.side?1:-1)*(e-i.entryPrice)*100*i.quantity}return{value:n}}(n,r,d,o).value),p=function(e,t){var i,l;let s=x(t),a=0;for(let t of Object.keys(null!==(i=e.positions)&&void 0!==i?i:{}))a+=(null!==(l=e.positions[t].totalShares)&&void 0!==l?l:0)*s;return x(a)}(D.pf,s);m(a),y(x(D.pf.cash.reserved)),I(u),C(p),A(x(a+u+p)),j(z(D.pf)),k(l)};(0,a.useEffect)(()=>{Y();let e=setInterval(Y,400);return()=>clearInterval(e)},[l,n]);let X=function(e,t){let i=0;for(let l of e.legs)if("SHORT"===l.side){let e=l.entryPrice,s="CALL"===l.right?Math.max(0,t-l.strike):Math.max(0,l.strike-t);i+=(Math.max(.2*t-s,.1*t)+e)*l.quantity}return Math.max(0,i)}(n,l),J=P>0?X/P:0,V=[...u,...H],Z=v(n,r,d,o);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Portfolio & Account (USD)"}),(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{children:"Initial deposit ($)"}),(0,s.jsx)("input",{type:"number",value:null!==(t=D.pf.cash.initial)&&void 0!==t?t:D.pf.cash.available,onChange:e=>{let t=parseFloat(e.target.value||"0");D.resetInitialDeposit(t),Y()}})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Cash available:"})," ",F(p)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Cash reserved:"})," ",F(g)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Stocks MTM:"})," ",F(O)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Options MTM:"})," ",F(q)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Equity:"})," ",F(P)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Margin req:"})," ",F(X)," (",(100*J).toFixed(0),"%)"]}),(0,s.jsx)("button",{onClick:()=>{var e;let t=new Blob([["id,timestamp,type,symbol,qty,price,strike,cashDelta,realizedPnL",...(null!==(e=D.pf.ledger)&&void 0!==e?e:[]).map(e=>{var t,i,l,s,a,r,n,d;let o=null!==(t=e.details)&&void 0!==t?t:{};return[e.id,new Date(e.timestamp).toISOString(),e.type,null!==(i=e.symbol)&&void 0!==i?i:"",null!==(s=null!==(l=o.qty)&&void 0!==l?l:o.shares)&&void 0!==s?s:"",null!==(a=o.price)&&void 0!==a?a:"",null!==(r=o.strike)&&void 0!==r?r:"",(null!==(n=e.cashDelta)&&void 0!==n?n:0).toFixed(2),(null!==(d=e.realizedPnL)&&void 0!==d?d:0).toFixed(2)].join(",")})].join("\n")],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(t),l=document.createElement("a");l.href=i,l.download="portfolio-ledger.csv",l.click(),URL.revokeObjectURL(i)},children:"Export ledger CSV"})]})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h4",{children:"Unified portfolio (Stocks + Options)"}),(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Type"}),(0,s.jsx)("th",{children:"Symbol"}),(0,s.jsx)("th",{children:"Side"}),(0,s.jsx)("th",{children:"Right"}),(0,s.jsx)("th",{children:"Qty / Shares"}),(0,s.jsx)("th",{children:"Strike"}),(0,s.jsx)("th",{children:"Expiry"}),(0,s.jsx)("th",{children:"DTE"}),(0,s.jsx)("th",{children:"Avg/Entry"}),(0,s.jsx)("th",{children:"Last price"}),(0,s.jsx)("th",{children:"Unrealized"})]})}),(0,s.jsxs)("tbody",{children:[0===V.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:11,children:"No positions yet."})}),V.map((e,t)=>{var i,l,a;let r="Stock"===e.type?"".concat(e.symbol,"-stock-").concat(t):"opt-".concat(t),n=e.unrealized>=0;return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.type}),"Stock"===e.type?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("td",{children:e.symbol}),(0,s.jsx)("td",{children:"-"}),(0,s.jsx)("td",{children:"-"}),(0,s.jsx)("td",{children:e.qty}),(0,s.jsx)("td",{children:"-"}),(0,s.jsx)("td",{children:"-"}),(0,s.jsx)("td",{children:"-"}),(0,s.jsx)("td",{children:F(e.avgCost)}),(0,s.jsx)("td",{children:F(e.lastPrice)}),(0,s.jsx)("td",{style:{color:n?"green":"crimson"},children:F(e.unrealized)})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("td",{children:null!==(i=e.symbol)&&void 0!==i?i:"-"}),(0,s.jsx)("td",{children:e.side}),(0,s.jsx)("td",{children:e.right}),(0,s.jsx)("td",{children:e.qty}),(0,s.jsx)("td",{children:e.strike}),(0,s.jsx)("td",{children:null!==(l=e.expiryAbs)&&void 0!==l?l:"-"}),(0,s.jsx)("td",{children:null!==(a=e.dte)&&void 0!==a?a:"-"}),(0,s.jsx)("td",{children:F(e.entryPrice)}),(0,s.jsx)("td",{children:F(e.lastPrice)}),(0,s.jsx)("td",{style:{color:n?"green":"crimson"},children:F(e.unrealized)})]})]},r)})]})]})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h4",{children:"Portfolio Greeks"}),(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Δ:"})," ",Z.delta.toFixed(3)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Γ:"})," ",Z.gamma.toFixed(5)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Θ:"})," ",Z.theta.toFixed(2)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Vega:"})," ",Z.vega.toFixed(2)]})]})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h4",{children:"Trade History"}),D.pf.ledger&&0!==D.pf.ledger.length?(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Time"}),(0,s.jsx)("th",{children:"Action"}),(0,s.jsx)("th",{children:"Symbol"}),(0,s.jsx)("th",{children:"Qty"}),(0,s.jsx)("th",{children:"Price"}),(0,s.jsx)("th",{children:"P/L"}),(0,s.jsx)("th",{children:"P/L %"})]})}),(0,s.jsx)("tbody",{children:(null!=(i=D.pf.ledger)?i:[]).filter(e=>{var t,i;return i=e.type,0!==(null!==(t=e.realizedPnL)&&void 0!==t?t:0)||"SELL_STOCK"===i||"BUY_STOCK"===i||"BUY_OPTION"===i||"SELL_OPTION"===i||"CLOSE_LONG_OPTION"===i||"CLOSE_SHORT_OPTION"===i||"ASSIGN_SHORT_CALL"===i||"ASSIGN_SHORT_PUT"===i||"EXERCISE_LONG_CALL"===i||"EXERCISE_LONG_PUT"===i}).map(e=>{var t,i,l,s,a,r,n,d,o,u,c;let h=null!==(r=null!==(a=null===(t=e.details)||void 0===t?void 0:t.qty)&&void 0!==a?a:null===(i=e.details)||void 0===i?void 0:i.shares)&&void 0!==r?r:"-",p=null!==(n=null===(l=e.details)||void 0===l?void 0:l.price)&&void 0!==n?n:"-",x=null!==(d=e.realizedPnL)&&void 0!==d?d:0,m=null!==(o=null===(s=e.details)||void 0===s?void 0:s.costBasis)&&void 0!==o?o:"number"==typeof h&&"number"==typeof p?h*p*100:void 0,g=m&&0!==m?"".concat((x/m*100).toFixed(2),"%"):"-";return{id:e.id,time:new Date(null!==(u=e.timestamp)&&void 0!==u?u:Date.now()).toLocaleString(),type:e.type,symbol:null!==(c=e.symbol)&&void 0!==c?c:"-",qty:h,price:p,plAbs:x,plPct:g}}).map(e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.time}),(0,s.jsx)("td",{children:e.type}),(0,s.jsx)("td",{children:e.symbol}),(0,s.jsx)("td",{children:e.qty}),(0,s.jsx)("td",{children:"number"==typeof e.price?R(100*e.price):"-"}),(0,s.jsx)("td",{style:{color:e.plAbs>=0?"green":"crimson"},children:F(e.plAbs)}),(0,s.jsx)("td",{children:e.plPct})]},e.id))})]}):(0,s.jsx)("p",{className:"muted",children:"No trades yet."})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h5",{children:"Quick underlying trade"}),(0,s.jsx)("input",{value:b,onChange:e=>S(e.target.value.toUpperCase()),placeholder:"Symbol",style:{width:80}}),(0,s.jsx)("input",{type:"number",value:L,onChange:e=>M(parseInt(e.target.value,10)||0),placeholder:"Shares",style:{width:100}}),(0,s.jsx)("input",{type:"number",inputMode:"decimal",step:"0.01",value:x(N).toFixed(2),onChange:e=>{k(x(parseFloat(e.target.value||"0")))},placeholder:"Price",style:{width:100}}),(0,s.jsx)("button",{onClick:()=>{let e=Date.parse(o.dates[d]);(function(e,t,i,l){if(!Number.isFinite(l.timestamp))throw Error("buyShares: fill.timestamp (simulation timeline day) is required");let s=l.timestamp,a=i*l.price;if(e.cash.available<a)throw Error("Insufficient cash: need ".concat(a.toFixed(2),", have ").concat(e.cash.available.toFixed(2)));e.cash.available-=a;let r={lotId:T("lot"),symbol:t,shares:i,costBasis:l.price,openedAt:s},n=E(e,t);n.lots.push(r),w(n),_(e,{id:T("led"),timestamp:s,type:"BUY_STOCK",symbol:t,details:{qty:i,price:l.price,costBasis:a},cashDelta:-a,realizedPnL:0})})(D.pf,b,L,{price:N,timestamp:e}),Y()},children:"Buy"}),(0,s.jsx)("button",{onClick:()=>{let e=Date.parse(o.dates[d]);(function(e,t,i,l){var s,a;if(!Number.isFinite(l.timestamp))throw Error("sellShares: fill.timestamp (simulation timeline day) is required");let r=l.timestamp,n=E(e,t),d=(null!==(s=n.totalShares)&&void 0!==s?s:0)-(null!==(a=n.reservedShares)&&void 0!==a?a:0);if(i>d)throw Error("Insufficient available shares: want ".concat(i,", have ").concat(d));let{totalCost:o,breakdown:u}=function(e,t){e.lots.sort((e,t)=>e.openedAt-t.openedAt);let i=t,l=0,s=[];for(let t of e.lots){if(i<=0)break;if(t.shares<=0)continue;let e=Math.min(t.shares,i),a=e*t.costBasis;t.shares-=e,l+=a,s.push({lotId:t.lotId,qty:e,lotCostBasis:t.costBasis}),i-=e}if(i>0)throw Error("Insufficient shares: need ".concat(t,", but only ").concat(t-i," available in lots"));return e.lots=e.lots.filter(e=>e.shares>0),{totalCost:l,breakdown:s}}(n,i),c=i*l.price;e.cash.available+=c,w(n),_(e,{id:T("led"),timestamp:r,type:"SELL_STOCK",symbol:t,details:{qty:i,price:l.price,costBasis:o,lots:u},cashDelta:c,realizedPnL:c-o})})(D.pf,b,L,{price:N,timestamp:e}),Y()},children:"Sell"}),(0,s.jsx)("p",{className:"muted",style:{marginTop:8},children:"No fees/slippage; educational paper-trading model."})]})]})}let H=0;function Y(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id",t=Date.now().toString(36),i=(H++).toString(36),l=Math.random().toString(36).slice(2,7);return"".concat(e,"-").concat(t).concat(i).concat(l)}let X=e=>Math.round((e+Number.EPSILON)*100)/100,J=(e,t,i)=>"CALL"===e?Math.max(0,t-i):Math.max(0,i-t);function V(e,t){var i,l;return null!==(l=(i=e.positions)[t])&&void 0!==l||(i[t]={symbol:t,lots:[],totalShares:0,avgCost:0,reservedShares:0}),e.positions[t]}function Z(e){let t=0,i=0;for(let l of e.lots)t+=l.shares,i+=l.shares*l.costBasis;e.totalShares=t,e.avgCost=t>0?X(i/t):0}function K(){var e,t,i,l;let[r,o]=(0,a.useState)({r:.03,q:0,sigma:.25}),[u,c]=(0,a.useState)("BULL"),[y,f]=(0,a.useState)(!0),[j,b]=(0,a.useState)({mu:.05,sigma:.25,seed:11}),[L,N]=(0,a.useState)({enabled:!1,lambda:2,muJ:-.2,sigmaJ:.25}),I="CUSTOM"===u?{key:"CUSTOM",label:"Custom",baseMu:j.mu,baseSigma:j.sigma}:d[u],[T,E]=(0,a.useState)(()=>n({S0:100,regime:I,days:420,seed:j.seed,randomize:y,jumps:L})),[_,w]=(0,a.useState)(30),[A,U]=(0,a.useState)(m()),[z,R]=(0,a.useState)(!1),[F,H]=(0,a.useState)(null),[K,Q]=(0,a.useState)([{day:0,realized:0}]);(0,a.useEffect)(()=>{E(n({S0:100,regime:I,days:420,seed:j.seed,randomize:y,jumps:L})),w(30),U(m()),Q([{day:0,realized:0}]),H(null),o(e=>({...e,sigma:I.baseSigma}))},[u,j.mu,j.sigma,j.seed,y,L.enabled,L.lambda,L.muJ,L.sigmaJ]);let $=x(T.prices[_]),W=T.dates[_],ee=A.expiryIndex?Math.max(0,A.expiryIndex-_):void 0;(0,a.useEffect)(()=>{if(void 0!==A.expiryIndex&&_>=A.expiryIndex&&A.legs.length>0){let e=Date.parse(T.dates[_]),t=x(T.prices[_]),i=0,l=0;for(let s of A.legs){let a=J(s.right,t,s.strike);if("LONG"===s.side){let t=x(100*a*s.quantity),r=x((a-s.entryPrice)*100*s.quantity);l+=t,G(D.pf,{timestamp:e,type:"CLOSE_LONG_OPTION",symbol:"XYZ",details:{right:s.right,qty:s.quantity,strike:s.strike,price:a},cashDelta:+t,realizedPnL:r}),i+=r}else if("PUT"===s.right){if(a>0)!function(e,t,i,l,s,a,r){let n=100*i,d=X(n*l);e.cash.available-=d;let o={lotId:"lot-".concat(Math.random().toString(36).slice(2,9)),symbol:"XYZ",shares:n,costBasis:l,openedAt:r},u=V(e,"XYZ");u.lots.push(o),Z(u),G(e,{timestamp:r,type:"BUY_STOCK",symbol:"XYZ",details:{qty:n,price:l,costBasis:d},cashDelta:-d,realizedPnL:0});let c=X((a-J("PUT",s,l))*100*i);G(e,{timestamp:r,type:"ASSIGN_SHORT_PUT",symbol:t,details:{qty:i,strike:l,price:a,sharesAssigned:n},cashDelta:0,realizedPnL:c})}(D.pf,"XYZ",s.quantity,s.strike,t,s.entryPrice,e);else{let t=x(100*s.entryPrice*s.quantity);G(D.pf,{timestamp:e,type:"CLOSE_SHORT_OPTION",symbol:"XYZ",details:{right:"PUT",qty:s.quantity,strike:s.strike,price:0},cashDelta:0,realizedPnL:t}),i+=t}}else if("CALL"===s.right){if(a>0)!function(e,t,i,l,s,a,r){var n,d,o;let u=100*i,c=V(e,"XYZ"),h=(null!==(n=c.totalShares)&&void 0!==n?n:0)-(null!==(d=c.reservedShares)&&void 0!==d?d:0);if(h<u){let e=null!==(o=c.reservedShares)&&void 0!==o?o:0;throw Error("Covered call assignment requires ".concat(u," deliverable shares; available=").concat(h,", reserved=").concat(e))}let{costConsumed:p,breakdown:x}=function(e,t){e.lots.sort((e,t)=>e.openedAt-t.openedAt);let i=t,l=0,s=[];for(let t of e.lots){if(i<=0)break;if(t.shares<=0)continue;let e=Math.min(t.shares,i);l+=e*t.costBasis,s.push({lotId:t.lotId,qty:e,lotCostBasis:t.costBasis}),t.shares-=e,i-=e}if(i>0)throw Error("Not enough shares to deliver: missing ".concat(i));return e.lots=e.lots.filter(e=>e.shares>0),Z(e),{costConsumed:l,breakdown:s}}(c,u),m=X(u*l);e.cash.available=X(e.cash.available+m),Z(c),G(e,{timestamp:r,type:"SELL_STOCK",symbol:"XYZ",details:{qty:u,price:l,costBasis:p,lots:x},cashDelta:+m,realizedPnL:X(m-p)});let g=X((a-J("CALL",s,l))*100*i);G(e,{timestamp:r,type:"ASSIGN_SHORT_CALL",symbol:"XYZ",details:{right:"CALL",qty:i,strike:l,price:a,sharesDelivered:u},cashDelta:0,realizedPnL:g})}(D.pf,"XYZ",s.quantity,s.strike,t,s.entryPrice,e);else{let t=x(100*s.entryPrice*s.quantity);G(D.pf,{timestamp:e,type:"CLOSE_SHORT_OPTION",symbol:"XYZ",details:{right:"CALL",qty:s.quantity,strike:s.strike,price:0},cashDelta:0,realizedPnL:t}),i+=t}}}0!==l&&(D.pf.cash.available+=l),0!==i&&Q(e=>{var t,l;return[...e,{day:_,realized:(null!==(l=null===(t=e.at(-1))||void 0===t?void 0:t.realized)&&void 0!==l?l:0)+i}]}),U(m())}},[_,A.expiryIndex]);let et=(0,a.useMemo)(()=>{let e=T.dates.slice(0,_+1),t=new Date(T.dates[_]);for(let i=1;i<=30;i++){let l=new Date(t);l.setDate(t.getDate()+i),e.push(l.toISOString().slice(0,10))}return e},[T.dates,_]),ei=(0,a.useMemo)(()=>{let e=T.prices.slice(0,_+1);for(let t=0;t<30;t++)e.push(null);return e},[T.prices,_]);v(A,r,_,T);let el=function(e,t,i,l){let s={delta:[],theta:[],vega:[],gamma:[],idxStart:i};for(let a=0;a<=i;a++){if(a<i){s.delta.push(0),s.theta.push(0),s.vega.push(0),s.gamma.push(0);continue}let r=l.prices[a],n=Math.max(0,(e.expiryIndex-a)/365),d=e.legs.reduce((e,i)=>{let l=p(r,i.strike,t.r,t.q,t.sigma,Math.max(1e-8,n),i.right);return e.delta+=g(i.side)*i.quantity*l.delta,e.gamma+=g(i.side)*i.quantity*l.gamma,e.vega+=g(i.side)*i.quantity*l.vega,e.theta+=g(i.side)*i.quantity*l.theta,e},{delta:0,gamma:0,vega:0,theta:0});s.delta.push(d.delta),s.theta.push(d.theta),s.vega.push(d.vega),s.gamma.push(d.gamma)}return s}(A,r,_,T),es=(0,a.useMemo)(()=>{if(!A.expiryIndex||0===A.legs.length)return[];let e=Math.max(0,A.expiryIndex-_),t=[0,1,5,10,20,30,60].filter(t=>t<=e),i=[],[l,s]=function(e,t){if(0===e.legs.length)return[[],[]];let i=e.legs.reduce((e,t)=>e+("LONG"===t.side?-1:1)*t.quantity*t.entryPrice*100,0),l=Math.max(.1,.7*t),s=1.3*t,a=[],r=[];for(let t=0;t<=200;t++){let n=l+t/200*(s-l),d=e.legs.reduce((e,t)=>{let i="CALL"===t.right?Math.max(0,n-t.strike):Math.max(0,t.strike-n);return e+("LONG"===t.side?1:-1)*t.quantity*i*100},0);a.push(n),r.push(d+i)}return[a,r]}(A,$);for(let e of(i.push({label:"Expiry",prices:l,values:s}),t)){if(0===e)continue;let[t,l]=function(e,t,i,l){if(0===e.legs.length)return[[],[]];let s=e.legs.reduce((e,t)=>e+("LONG"===t.side?-1:1)*t.quantity*t.entryPrice*100,0),a=Math.max(.1,.7*i),r=1.3*i,n=[],d=[];for(let i=0;i<=200;i++){let o=a+i/200*(r-a),u=e.legs.reduce((e,i)=>{let s=x(h(o,i.strike,t.r,t.q,t.sigma,Math.max(0,l),i.right));return e+("LONG"===i.side?1:-1)*i.quantity*s*100},0);n.push(o),d.push(u+s)}return[n,d]}(A,r,$,e/365);i.push({label:"".concat(e,"d before"),prices:t,values:l})}return i},[A,r,_,$]),ea=()=>w(e=>Math.min(T.prices.length-31,e+1));(0,a.useEffect)(()=>{let e=e=>{("n"===e.key||"N"===e.key||"ArrowRight"===e.key)&&(e.preventDefault(),ea()),("a"===e.key||"A"===e.key)&&(e.preventDefault(),R(!0)),("c"===e.key||"C"===e.key)&&(e.preventDefault(),U(m())),"Escape"===e.key&&(R(!1),H(null))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[_]);let er=new Set(["BUY_OPTION","SELL_OPTION","CLOSE_LONG_OPTION","CLOSE_SHORT_OPTION","ASSIGN_SHORT_CALL","ASSIGN_SHORT_PUT","EXERCISE_LONG_CALL","EXERCISE_LONG_PUT"]);function en(e,t,i){let l=e.map((e,i)=>i<=t?x(null!=e?e:0):null);return l.length<i&&l.push(...Array(i-l.length).fill(null)),l}let ed=null!==(t=null===(e=D.pf.ledger)||void 0===e?void 0:e.length)&&void 0!==t?t:0,{realizedStocks:eo,unrealizedStocks:eu}=(0,a.useMemo)(()=>{var e;let t=T.prices.map(x);return function(e,t,i,l){let s=Date.parse(t[Math.min(l,t.length-1)]),a=[...null!=e?e:[]].map(e=>({...e,_ts:Number.isFinite(e.timestamp)?e.timestamp:s})).sort((e,t)=>e._ts-t._ts),r={},n=[],d=[],o=0;for(let e=0;e<t.length;e++){var u,c,h,p,m,g,y,v,f,j,b,S,L,M,N,k,O,C,q;let l=t[e],s=null!==(u=i[e])&&void 0!==u?u:0;for(;o<a.length&&new Date(null!=(q=a[o]._ts)?q:0).toISOString().slice(0,10)<=l;){let e=a[o],t=null!==(m=e.symbol)&&void 0!==m?m:"_",i=null!==(g=r[t])&&void 0!==g?g:r[t]={shares:0,cost:0,realized:0},l=null!==(v=null!==(y=null===(c=e.details)||void 0===c?void 0:c.qty)&&void 0!==y?y:null===(h=e.details)||void 0===h?void 0:h.shares)&&void 0!==v?v:0,s=null!==(f=null===(p=e.details)||void 0===p?void 0:p.price)&&void 0!==f?f:0;switch(e.type){case"BUY_STOCK":i.shares+=l,i.cost+=l*s;break;case"SELL_STOCK":if(i.shares>0){let e=i.cost/i.shares,t=(s-e)*l;i.shares-=l,i.cost-=e*l,i.realized+=t}else i.realized+=null!==(j=e.realizedPnL)&&void 0!==j?j:0;break;case"DIVIDEND":{let t=null!==(L=null!==(S=null===(b=e.details)||void 0===b?void 0:b.amount)&&void 0!==S?S:e.cashDelta)&&void 0!==L?L:0;i.realized+=t;break}case"ASSIGN_SHORT_CALL":case"ASSIGN_SHORT_PUT":case"EXERCISE_LONG_CALL":case"EXERCISE_LONG_PUT":{let t=null!==(k=null===(M=e.details)||void 0===M?void 0:M.qty)&&void 0!==k?k:0,l=null!==(O=null===(N=e.details)||void 0===N?void 0:N.strike)&&void 0!==O?O:0;i.shares+=t,i.cost+=t*l,i.realized+=null!==(C=e.realizedPnL)&&void 0!==C?C:0}}o++}let I=0,P=0;for(let e of Object.keys(r)){let t=r[e];if(t.shares>0){let e=t.cost/t.shares;I+=t.shares*(s-e)}P+=t.realized}n.push(x(P)),d.push(x(I))}return{realizedStocks:n,unrealizedStocks:d}}(null!==(e=D.pf.ledger)&&void 0!==e?e:[],T.dates,t,_)},[ed,T.dates,T.prices,_]),ec=(0,a.useMemo)(()=>(function(e,t,i){let l=[];for(let a=0;a<i.dates.length;a++){var s;let r=null!==(s=i.prices[a])&&void 0!==s?s:0,n=void 0!==e.expiryIndex?Math.max(0,(e.expiryIndex-a)/365):0,d=0;for(let i of e.legs){if(void 0!==i.entryIndex&&a<i.entryIndex)continue;let e=x(h(r,i.strike,t.r,t.q,t.sigma,n,i.right));d+=("LONG"===i.side?1:-1)*(e-i.entryPrice)*100*i.quantity}l.push(Math.round(100*d)/100)}return l})(A,r,T),[A,r,T]),eh=(0,a.useMemo)(()=>{var e;return function(e,t,i){let l=[...null!=e?e:[]].filter(e=>er.has(e.type)).sort((e,t)=>{var i,l;return(null!==(i=e.timestamp)&&void 0!==i?i:0)-(null!==(l=t.timestamp)&&void 0!==l?l:0)}),s=[],a=0,r=0;for(let e=0;e<t.length;e++){let o=t[e];for(;r<l.length;){var n,d;if(new Date(null!==(n=l[r].timestamp)&&void 0!==n?n:0).toISOString().slice(0,10)<=o)a+=null!==(d=l[r].realizedPnL)&&void 0!==d?d:0,r++;else break}s.push(e<=i?Math.round((a+Number.EPSILON)*100)/100:null)}return s}(null!==(e=D.pf.ledger)&&void 0!==e?e:[],T.dates,_)},[ed,T.dates,_]),ep=et.length,ex=(0,a.useMemo)(()=>en(eo,_,ep),[eo,_,ep]),em=(0,a.useMemo)(()=>en(eu,_,ep),[eu,_,ep]),eg=(0,a.useMemo)(()=>{let e=eh.map((e,t)=>t<=_?x(null!=e?e:0):null);return e.length<ep&&e.push(...Array(ep-e.length).fill(null)),e},[eh,_,ep]),ey=(0,a.useMemo)(()=>en(ec,_,ep),[ec,_,ep]);(0,a.useMemo)(()=>et.map((e,t)=>{var i,l;let s=null!==(i=ex[t])&&void 0!==i?i:0,a=null!==(l=eg[t])&&void 0!==l?l:0;return t<=_?x(s+a):null}),[et,_,ex,eg]),(0,a.useMemo)(()=>et.map((e,t)=>{var i,l,s,a;let r=null!==(i=ex[t])&&void 0!==i?i:0,n=null!==(l=eg[t])&&void 0!==l?l:0,d=null!==(s=em[t])&&void 0!==s?s:0,o=null!==(a=ey[t])&&void 0!==a?a:0;return t<=_?x(r+n+d+o):null}),[et,_,ex,eg,em,ey]);let ev=null!==(l=null!==(i=D.pf.cash.initial)&&void 0!==i?i:D.pf.cash.available)&&void 0!==l?l:0,ef=(0,a.useMemo)(()=>et.map((e,t)=>{var i,l;return t<=_?x(ev+(null!==(i=ex[t])&&void 0!==i?i:0)+(null!==(l=eg[t])&&void 0!==l?l:0)):null}),[et,_,ev,ex,eg]),ej=(0,a.useMemo)(()=>et.map((e,t)=>{var i,l,s,a;return t<=_?x(ev+(null!==(i=ex[t])&&void 0!==i?i:0)+(null!==(l=eg[t])&&void 0!==l?l:0)+(null!==(s=em[t])&&void 0!==s?s:0)+(null!==(a=ey[t])&&void 0!==a?a:0)):null}),[et,_,ev,ex,eg,em,ey]);return(0,s.jsxs)("div",{className:"grid2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"h1",children:"Options Timeline Simulator"}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Price history (+30 days ahead)"}),(0,s.jsx)(S,{labels:et,datasets:[{label:"Price",data:ei,color:"#22c55e"}]})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsxs)("div",{className:"row wrap",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Day:"})," ",_]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Date:"})," ",W]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"Spot S:"})," ",$.toFixed(2)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"r:"})," ",r.r.toFixed(3)," | ",(0,s.jsx)("b",{children:"q:"})," ",r.q.toFixed(3)," | ",(0,s.jsx)("b",{children:"σ:"})," ",r.sigma.toFixed(2)]}),void 0!==ee&&(0,s.jsxs)("div",{children:[(0,s.jsx)("b",{children:"DTE:"})," ",ee," day(s)"]})]}),(0,s.jsxs)("div",{className:"row",children:[(0,s.jsx)("button",{onClick:ea,children:"Next day ▶ (N)"}),(0,s.jsx)("button",{onClick:()=>R(!0),children:"Take action (A)"})]}),(0,s.jsx)("p",{className:"muted",children:"Shortcuts: N/→ next, A action, Esc close dialog."})]}),(0,s.jsx)(B,{S:$,env:r,pos:A,idx:_,hist:T}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Greeks timeline"}),(0,s.jsx)(S,{labels:et,datasets:[{label:"Δ (Delta)",data:el.delta.concat(Array(Math.max(0,et.length-el.delta.length)).fill(null)),color:"#60a5fa"},{label:"Θ (Theta/yr)",data:el.theta.concat(Array(Math.max(0,et.length-el.theta.length)).fill(null)),color:"#f97316"},{label:"Vega",data:el.vega.concat(Array(Math.max(0,et.length-el.vega.length)).fill(null)),color:"#22c55e"}]})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Payoff slices (expiry & selected days before expiry)"}),0===es.length?(0,s.jsx)("p",{className:"muted",children:"No open position"}):(0,s.jsx)(M,{series:es})]}),(0,s.jsxs)("section",{className:"panel",children:[(0,s.jsx)("h3",{children:"Equity growth (Realized vs Total)"}),(0,s.jsx)(S,{labels:et,datasets:[{label:"Equity (Realized)",data:ef,color:"#22c55e"},{label:"Equity (Total)",data:ej,color:"#eab308"}]})]})]}),(0,s.jsx)(q,{S:$,T:(null!=ee?ee:0)/365,env:r,onPick:function(e){let t=C.find(t=>t.key===e);t&&(H({legs:t.build($),expiryDays:(null!=ee?ee:30)||30}),R(!0))}}),(0,s.jsx)(P,{S:$,env:r,dates:T.dates.slice(0,_+1),prices:T.prices.slice(0,_+1),jumpsEnabled:L.enabled}),(0,s.jsx)(O,{regime:I.key,setRegime:c,custom:j,setCustom:b,randomize:y,setRandomize:f,jumps:L,setJumps:N}),z&&(0,s.jsx)(k,{env:r,currentIndex:_,position:A,onClose:()=>{R(!1),H(null)},onSubmit:e=>{R(!1),function(e){let t=e(A,r,_,T),i=0,l=A.legs.filter(e=>!t.legs.find(t=>t.id===e.id));if(l.length>0){let e=Math.max(0,(A.expiryIndex-_)/365),t=Date.parse(T.dates[_]);for(let s of(i+=l.map(t=>({side:t.side,right:t.right,quantity:t.quantity,price:x(h(T.prices[_],t.strike,r.r,r.q,r.sigma,e,t.right))})).reduce((e,t)=>e+("LONG"===t.side?1:-1)*t.quantity*t.price*100,0),l)){let i=x(h(T.prices[_],s.strike,r.r,r.q,r.sigma,e,s.right)),l=("LONG"===s.side?1:-1)*(i-s.entryPrice)*100*s.quantity;G(D.pf,{id:Y("led"),timestamp:t,type:"LONG"===s.side?"CLOSE_LONG_OPTION":"CLOSE_SHORT_OPTION",symbol:"-",details:{right:s.right,qty:s.quantity,price:i,strike:s.strike},cashDelta:("LONG"===s.side?1:-1)*i*100*s.quantity,realizedPnL:l})}}let s=t.legs.filter(e=>!A.legs.find(t=>t.id===e.id));if(s.length>0){let e=Date.parse(T.dates[_]);for(let t of s)t.entryIndex=_,t.entryTimestamp=e;for(let t of(i+=s.map(e=>({side:e.side,right:e.right,quantity:e.quantity,price:e.entryPrice})).reduce((e,t)=>e+("LONG"===t.side?-1:1)*t.quantity*t.price*100,0),s))G(D.pf,{id:Y("led"),timestamp:e,type:"LONG"===t.side?"BUY_OPTION":"SELL_OPTION",symbol:"-",details:{right:t.right,qty:t.quantity,price:t.entryPrice,strike:t.strike},cashDelta:("LONG"===t.side?-1:1)*t.entryPrice*100*t.quantity,realizedPnL:0})}0!==i&&(D.pf.cash.available+=i),t.realized!==A.realized&&Q(e=>[...e,{day:_,realized:t.realized}]),U(t)}(e),H(null)},hist:T,preset:F})]})}null===(l=D.pf.ledger)||void 0===l||l.length}},function(e){e.O(0,[674,746,971,23,744],function(){return e(e.s=7207)}),_N_E=e.O()}]);